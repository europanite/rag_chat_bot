name: Snapshot

on:
  workflow_dispatch:
    inputs:
      cam:
        description: "Select a known safe snapshot source (or choose 'custom')"
        required: true
        type: choice
        default: "coastcam_cam2_yokosuka"
        options:
          - coastcam_cam2_yokosuka
          - coastcam_cam1_hayama
          - coastcam_cam3_miura
          - custom
      url:
        description: "If cam=custom, put direct image URL (jpg/png). Otherwise ignored."
        required: false
        default: ""
      out_name:
        description: "Output filename (artifact). e.g., snapshot.jpg"
        required: false
        default: "snapshot.jpg"

jobs:
  capture:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Resolve snapshot URL
        id: resolve
        env:
          CAM: ${{ github.event.inputs.cam }}
          CUSTOM_URL: ${{ github.event.inputs.url }}
        run: |
          set -euo pipefail

          case "$CAM" in
            coastcam_cam2_yokosuka)
              URL="https://coast-cam.com/images/cam2.jpg"
              ;;
            coastcam_cam1_hayama)
              URL="https://coast-cam.com/images/cam1.jpg"
              ;;
            coastcam_cam3_miura)
              URL="https://coast-cam.com/images/cam3.jpg"
              ;;
            custom)
              if [ -z "${CUSTOM_URL:-}" ]; then
                echo "ERROR: cam=custom requires inputs.url"
                exit 1
              fi
              URL="${CUSTOM_URL}"
              ;;
            *)
              echo "ERROR: unknown cam: $CAM"
              exit 1
              ;;
          esac

          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "Resolved URL: $URL"

      - name: Capture 1 snapshot
        env:
          SNAP_URL: ${{ steps.resolve.outputs.url }}
          OUT_NAME: ${{ github.event.inputs.out_name }}
        run: |
          set -euo pipefail

          python - <<'PY'
          import os, time
          import requests

          url = os.environ["SNAP_URL"].strip()
          out = os.environ.get("OUT_NAME","snapshot.jpg").strip() or "snapshot.jpg"

          # cache buster (harmless even if ignored)
          sep = "&" if "?" in url else "?"
          url2 = f"{url}{sep}t={int(time.time())}"

          headers = {
            "User-Agent": "snapshot-safe-http/1.0 (+github-actions)",
            "Accept": "image/*",
            "Cache-Control": "no-cache",
            "Pragma": "no-cache",
          }

          r = requests.get(url2, headers=headers, timeout=30)
          r.raise_for_status()

          ctype = (r.headers.get("Content-Type","") or "").lower()
          if "image" not in ctype:
            raise RuntimeError(f"Non-image response: Content-Type={ctype}")

          with open(out, "wb") as f:
            f.write(r.content)

          print(f"OK: saved {out} bytes={len(r.content)} type={ctype}")

          # nice summary
          with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as s:
            s.write(f"### Snapshot OK\n- url: `{url}`\n- out: `{out}`\n- content-type: `{ctype}`\n- bytes: `{len(r.content)}`\n")
          PY

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: snapshot
          path: ${{ github.event.inputs.out_name }}
