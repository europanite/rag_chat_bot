name: Diary

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: diary
  cancel-in-progress: false

jobs:
  rag:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify local index (chroma_db)
        run: |
          if [[ ! -d chroma_db ]]; then
            echo "ERROR: ./chroma_db not found. Run the manual Ingest workflow once to create it." >&2
            exit 1
          fi
          # Exclude placeholder files (like .gitkeep)
          files="$(find chroma_db -type f ! -name '.gitkeep' 2>/dev/null | head -n 1 || true)"
          if [[ -z "${files}" ]]; then
            echo "ERROR: ./chroma_db is empty. Run the manual Ingest workflow to build the index." >&2
            exit 1
          fi
          echo "chroma_db looks present. (showing up to 20 files)"
          find chroma_db -maxdepth 2 -type f ! -name '.gitkeep' | head -n 20 || true
          du -sh chroma_db || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start stack (db + ollama + backend)
        env:
          RAG_AUTO_INDEX: "false"
          RAG_REBUILD_ON_START: "false"
          RAG_REINDEX_ENABLED: "false"
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d --build

      - name: Generate diary
        env:
          TZ: Asia/Tokyo
          API_BASE: http://localhost:8000
          LAT: "35.2810"
          LON: "139.6722"
          PLACE: "Yokosuka"
          TOP_K: 6
          MAX_CHARS: 1024
          RAG_REINDEX_ON_EMPTY: "0"
        run: |
          chmod +x scripts/generate_diary.sh
          scripts/generate_diary.sh

      - name: Fix permissions for feed dirs
        run: |
          sudo chown -R runner:runner frontend/app/public/feed || true
          sudo chown -R runner:runner frontend/app/public || true
          ls -la frontend/app/public/feed || true

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull
          git add frontend/app/public/feed frontend/app/public/latest.json || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: update diary feed"
          git push

  pages:
    needs: rag
    if: needs.run.outputs.changed == '1'
    uses: ./.github/workflows/pages.yml
    with:
      ref: main
    permissions:
      contents: read
      pages: write
      id-token: write
