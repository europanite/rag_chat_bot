name: Feed

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # hourly (UTC). With TZ_NAME=Asia/Tokyo this is JST+9

permissions:
  contents: write

concurrency:
  group: feed
  cancel-in-progress: false

jobs:
  rag:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.diff.outputs.changed }}
      sha: ${{ steps.sha.outputs.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true

      - name: Fix permissions for feed dirs
        run: |
          mkdir -p frontend/app/public/feed frontend/app/public/image frontend/app/public/diary frontend/app/public/share_sd
          chmod -R u+rwX,go+rX,go-w frontend/app/public/feed frontend/app/public/image frontend/app/public/diary frontend/app/public/share_sd

      - name: Generate latest + feed item
        env:
          TZ_NAME: Asia/Tokyo
          FEED_PATH: frontend/app/public
          LATEST_PATH: frontend/app/public/latest.json
          DOCS_DIR: frontend/app/public/data/json
          WEATHER_SNAPSHOT_PATH: frontend/app/public/weather_snapshot.json
          FEED_MAX_ITEMS: "50"
        run: |
          python scripts/generate_diary.py

      - name: Build feed pages
        run: |
          python scripts/build_feed_pages.py

      - name: Git diff?
        id: diff
        run: |
          if git diff --quiet; then
            echo "changed=0" >> $GITHUB_OUTPUT
          else
            echo "changed=1" >> $GITHUB_OUTPUT
          fi

      - name: Record sha
        id: sha
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Commit & push (if changed)
        if: steps.diff.outputs.changed == '1'
        run: |
          git pull
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update feed" || true
          git push

  illustrate:
    runs-on: ubuntu-latest
    needs: rag
    if: needs.rag.outputs.changed == '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fast-forward to rag sha
        run: |
          git fetch origin main
          git checkout main
          git reset --hard ${{ needs.rag.outputs.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pillow

      - name: Illustrate latest feed item
        env:
          FEED_DIR: frontend/app/public/feed
          OUT_DIR: frontend/app/public/image
          LATEST_PATH: frontend/app/public/latest.json
          TZ_NAME: Asia/Tokyo
        run: |
          python - << 'PY'
          import os, json, hashlib
          from pathlib import Path
          from datetime import datetime

          FEED_DIR = Path(os.environ["FEED_DIR"])
          OUT_DIR = Path(os.environ["OUT_DIR"])
          LATEST_PATH = Path(os.environ["LATEST_PATH"])

          def load_json(p: Path):
            return json.loads(p.read_text(encoding="utf-8"))

          def dump_json(p: Path, data):
            p.parent.mkdir(parents=True, exist_ok=True)
            p.write_text(json.dumps(data, ensure_ascii=False, indent=2) + "\n", encoding="utf-8")

          def slug(s: str) -> str:
            s = (s or "").strip()
            out = []
            for ch in s:
              if ch.isalnum() or ch in "._-":
                out.append(ch)
              elif ch.isspace():
                out.append("-")
            x = "".join(out).strip("-")
            return x or "x"

          latest = load_json(LATEST_PATH)
          text = latest.get("text","")
          date = latest.get("date","")
          generated_at = latest.get("generated_at","")

          # Deterministic seed source (fine)
          seed_src = f"{date}|{text}"
          seed_hex8 = hashlib.sha256(seed_src.encode("utf-8")).hexdigest()[:8]

          # Pick feeds for patching
          feeds = []
          if FEED_DIR.exists():
              feeds = sorted(FEED_DIR.glob("feed_*.json"), key=lambda x: x.name, reverse=True)

          # Prefer using the timestamp from latest.json's generated_at for the image filename.
          # This avoids "sticking" to an older feed filename when the latest feed file name doesn't change
          # or when feeds are missing/misaligned.
          def stamp_from_generated_at(iso_z: str, tz_name: str) -> str:
              if not iso_z:
                  return ""
              try:
                  # generated_at is stored as ISO8601 like "2025-12-27T15:17:02Z"
                  dt = datetime.fromisoformat(iso_z.replace("Z", "+00:00"))
                  try:
                      from zoneinfo import ZoneInfo  # py3.9+
                      dt = dt.astimezone(ZoneInfo(tz_name))
                      tz_abbr = dt.tzname() or "LOCAL"
                  except Exception:
                      tz_abbr = "LOCAL"
                  return dt.strftime("%Y%m%d_%H%M%S") + "_" + tz_abbr
              except Exception:
                  return ""

          tz_name = os.environ.get("TZ_NAME", "Asia/Tokyo")
          stamp = stamp_from_generated_at(generated_at, tz_name)
          if stamp:
              feed_stem = f"feed_{stamp}"
          else:
              feed_stem = feeds[0].stem if feeds else f"{slug(date)}_{seed_hex8}"

          fn = f"{feed_stem}.png"
          OUT_DIR.mkdir(parents=True, exist_ok=True)
          out_path = OUT_DIR / fn

          # If the same file already exists and latest points to it, skip heavy work.
          rel_url = f"/image/{fn}"
          if latest.get("image_url") == rel_url and out_path.exists():
            print("[skip] already has image:", out_path)
          else:
            # Minimal placeholder image generation (replace with your real generator if needed)
            from PIL import Image, ImageDraw
            img = Image.new("RGB", (1024, 1024), color=(20, 20, 20))
            draw = ImageDraw.Draw(img)
            draw.text((40, 40), "image placeholder", fill=(220, 220, 220))
            img.save(out_path)
            print("[ok] wrote image:", out_path)

          # Patch latest.json with image metadata
          latest["image_url"] = rel_url
          latest["image_prompt"] = latest.get("image_prompt") or ""
          latest["image_generated_at"] = datetime.utcnow().replace(microsecond=0).isoformat() + "Z"
          dump_json(LATEST_PATH, latest)

          # Patch the corresponding feed file entry
          def patch_feed_file(feed_path: Path):
            d = load_json(feed_path)
            items = d.get("items", [])
            if not isinstance(items, list):
              return
            for it in items:
              if not isinstance(it, dict):
                continue
              # match either by generated_at (preferred) or by (date,text)
              same_id = bool(generated_at) and str(it.get("id","")) == generated_at
              same_dt = str(it.get("date","")) == str(date) and str(it.get("text","")) == str(text)
              if same_id or same_dt:
                it["id"] = feed_stem
                it["image_url"] = rel_url
                it["image_prompt"] = latest.get("image_prompt","")
                it["image_generated_at"] = latest.get("image_generated_at","")
                break
            dump_json(feed_path, d)

          if feeds:
              # Patch the feed file that actually contains this generated_at item if possible.
              target = None
              for p in feeds:
                  try:
                      d = load_json(p)
                      items = d.get("items", []) if isinstance(d, dict) else []
                      if any(str(it.get("generated_at", "")) == generated_at or str(it.get("id", "")) == generated_at for it in items):
                          target = p
                          break
                  except Exception:
                      continue
              patch_feed_file(target or feeds[0])

          # Update image index
          idx_path = OUT_DIR / "index.json"
          files = sorted([p.name for p in OUT_DIR.glob("*.png")], reverse=True)
          dump_json(idx_path, {"files": files})
          print("[ok] updated index:", idx_path)
          PY

      - name: Commit & push images
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update images" || true
          git pull
          git push
